#!/bin/bash

#BASH SCRIPT TO AUTOMATICALLY SET UP BENZENE MD SIMULATIONS TO TURN OFF INTERACTIONS
#By: Eric Dybeck 09/12/2014
#param n - polymorph number (all 3 will be used if none is given)
#param G - Gamma state for the harmonic restraint
#param g - spacing between the Gammas
#param A - Maximum gamma value (%)
#param B - Minimum gamma value (%)
#param T - Temperature in K
#param P - Pressure in ???
#param N - Number of benzene molecules
#param e - Number of steps in the equilibration step
#param p - Number of steps in the production step
#param i - Integrator
#param t - Thermostat
#param b - Barostat
#param k - maximum harmonic restraint constant
#param r - vdw/coulomb cutoff distance (in angstroms)
#param h - optional string hinge to add to the job

#=============================================================================================
# SETUP DEFAULT VALUES AND READ IN PARAMETERS FROM USER
#=============================================================================================

SETRUN_ARGS="$@"
polymorph_num="all"
MINGAMMA=0
MAXGAMMA=100
GSPACING=10
LAMBDA=100
TEMP=200
MOLECULES=72
equil_steps=100000
prod_steps=1000000
integrator="md"
thermostat="v-rescale"
barostat=-1
k_max=1000
Gamma=0
EXPONENT=1
CUTOFF="6"
hinge="DefaultHinge"

#options passed in from the users
while getopts "n:A:B:g:L:T:P:N:e:p:i:t:b:k:r:h:" opt; do
        case $opt in
        n )
                polymorph_num=$OPTARG
                ;;
	A )
                MAXGAMMA=$OPTARG
                ;;
        B )
                MINGAMMA=$OPTARG
                ;;
	g )
		GSPACING=$OPTARG
		;;
	L )
		LAMBDA=$OPTARG
		;;
	T )
		TEMP=$OPTARG
		;;
        P )
                PRESSURE=$OPTARG
                ;;
        N )
                MOLECULES=$OPTARG
                ;;
        e )
                equil_steps=$OPTARG
                ;;
        p )
                prod_steps=$OPTARG
                ;;
        i )
                integrator=$OPTARG
                ;;
        t )
                thermostat=$OPTARG
                ;;
        b )
                barostat=$OPTARG
                ;;
	k )
                k_max = $OPTARG
                ;;
	r )
                CUTOFF=$OPTARG
                ;;
        h )
                hinge=$OPTARG
                ;;
        esac
done

#=============================================================================================
# ENSURE THAT INPUTS HAVE BEEN PROPERLY ENTERED
#=============================================================================================

#TEMPERATURE
if [ $TEMP == -1 ]; then
	echo "Invalid Temperature: $Temp"
	exit 1
fi

#POLYMORPH NUMBER
if [ $polymorph_num != "p1" ] && [ $polymorph_num != "p2" ] && [ $polymorph_num != "p3" ] && [ $polymorph_num != "all" ]; then
        echo "Unrecognized polymorph Number: $polymorph_num"
        exit 1
fi
#GAMMA

if [ "$GSPACING" -le "0" ]; then
	echo "Invalid Gamma Spacing: $GSPACING"
	exit 1
fi

#NUMBER OF MOLECULES (currently only 72, 108, 256 is accepted)
if [ $MOLECULES != 256 ] && [ $MOLECULES != 108 ] && [ $MOLECULES != 72 ]; then
        echo "Unsupported number of molecules: $MOLECULES"
        exit 1
fi

#NUMBER OF EQUILIBRATION TIMESTEPS
#if [ N != 256 ]
#        echo "Unsupported number of molecules: $MOLECULES"
#        exit 1
#fi

#NUMBER OF PRODUCTION TIMESTEPS
#if [ MOLECULES != 256 ]
#        echo "Unsupported number of molecules: $MOLECULES"
#        exit 1
#fi

#INTEGRATOR
if [ $integrator != "md" ] && [ $integrator != "md-vv" ]; then
        echo "Unrecognized integrator: $integrator"
        exit 1
fi

#SPRING CONSTANT
if [ $k_max -lt 0 ]; then
        echo "Invalid spring constant: $k_max"
        exit 1
fi

#CUTOFF RADIUS
if [ "$CUTOFF" -lt "0" ]; then
        echo "Invalid Cutoff Radius: $CUTOFF"
        exit 1
fi

#=============================================================================================
# SETUP INTERACTION DISSAPEARANCE PATH
#=============================================================================================

RawGamma=$MINGAMMA
while [ "$RawGamma" -lt "$MAXGAMMA" ]; do
	Gamma=$(echo "($RawGamma^$EXPONENT) / ($MAXGAMMA^($EXPONENT-1))" | bc)
	if [ $polymorph_num == "p1" ]; then
		setup_benzene -n p1 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $Gamma -r 6 -h $hinge
	elif [ $polymorph_num == "p2" ]; then
		setup_benzene -n p2 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $Gamma -r $CUTOFF -h $hinge
	elif [ $polymorph_num == "p3" ]; then
		setup_benzene -n p3 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $Gamma -r $CUTOFF -h $hinge
	else
		setup_benzene -n p1 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $Gamma -r $CUTOFF -h $hinge
		setup_benzene -n p2 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $Gamma -r $CUTOFF -h $hinge
		setup_benzene -n p3 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $Gamma -r $CUTOFF -h $hinge
	fi
	let "RawGamma=$RawGamma+$GSPACING"
done

#Catch the final gamma off-by-one exception
if [ $polymorph_num == "p1" ]; then
	setup_benzene -n p1 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $MAXGAMMA -r 6 -h $hinge
elif [ $polymorph_num == "p2" ]; then
        setup_benzene -n p2 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $MAXGAMMA -r $CUTOFF -h $hinge
elif [ $polymorph_num == "p3" ]; then
        setup_benzene -n p3 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $MAXGAMMA -r $CUTOFF -h $hinge
else
        setup_benzene -n p1 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $MAXGAMMA -r $CUTOFF -h $hinge
        setup_benzene -n p2 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $MAXGAMMA -r $CUTOFF -h $hinge
        setup_benzene -n p3 -T $TEMP -N $MOLECULES -e $equil_steps -p $prod_steps -U $LAMBDA -R $LAMBDA -L $LAMBDA -k $k_max -A $MAXGAMMA -B $MINGAMMA -g $GSPACING -G $MAXGAMMA -r $CUTOFF -h $hinge
fi

